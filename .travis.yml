language: python
python: 3.7
install:
  - pip install -r requirements.txt
script:
  - python run_linter.py *
env:
  global:
    - GCP_ENV=$(if [[ "$TRAVIS_BRANCH" = "master" ]]; then echo "prod"; else echo "$TRAVIS_BRANCH"; fi)
    - GCP_PROJECT_ID=$(echo "${GCP_ENV}_project_id")
notifications:
  email: false
  slack:
    rooms: bpsmart:cOFxwweHbT66YDbMwzgUaCZJ
    template:
      - 'Build <%{build_url}|#%{build_number}> (<%{compare_url}|%{commit}: ''%{commit_subject}''>)  by
      %{author} for %{repository_name}@%{branch}, %{result} in %{duration}. <%{build_url}|Check
      details>.'
before_install:
  - openssl aes-256-cbc -K $encrypted_d7c9028a9f74_key -iv $encrypted_d7c9028a9f74_iv
    -in ./deploy/ci-sec.tar.enc -out ./deploy/ci-sec.tar -d
  - tar xvf ./deploy/ci-sec.tar -C ./deploy/ &>/dev/null
before_script:
  - chmod +x ./deploy/pre_deploy.sh
  - ./deploy/pre_deploy.sh
deploy:
  provider: gae
  keyfile: $(echo "./deploy/travisci-bpsmart-${GCP_ENV}-service.json")
  project: $(echo "${!GCP_PROJECT_ID}")
  skip_cleanup: true
  on:
    all_branches: true
    condition: "$TRAVIS_BRANCH =~ ^(master|qa|dev)$"